<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Todo List</title>
  <link rel="stylesheet" href="/styles.css">
  <script>
    // Force ALL date/time inputs to English
    document.addEventListener('DOMContentLoaded', () => {
      const inputs = document.querySelectorAll('input[type="date"], input[type="time"]');
      inputs.forEach(input => {
        input.lang = 'en-GB';
        input.setAttribute('lang', 'en-GB');
        input.style.fontFamily = 'Arial, sans-serif';
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <!-- Delete Confirm Modal -->
    <div id="deleteModal" class="delete-modal">
      <div class="modal-content">
        <h3>Delete Todo?</h3>
        <p>Are you sure you want to delete "<span id="deleteTitle"></span>"?</p>
        <form id="deleteForm" action="" method="POST">
          <button type="submit" class="confirm-btn">Yes, Delete</button>
          <button type="button" onclick="closeModal()" class="cancel-btn">Cancel</button>
        </form>
      </div>
    </div>

    <script>
    function openDeleteModal(id, title) {
      document.getElementById('deleteTitle').textContent = title;
      document.getElementById('deleteForm').action = '/todos/delete/' + id;
      document.getElementById('deleteModal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }
    </script>
    <div class="header">
      <h1 class="title">TODO LIST</h1>
      <a href="/logout" class="logout-btn">Logout</a>
  </div>
  <div class="divider-long"></div>
  
    <p class="welcome">Welcome, <strong><%= username %></strong>!</p>

    <% if (msg === 'created') { %>
      <p class="success">Todo created successfully!</p>
    <% } else if (msg === 'updated') { %>
      <p class="success">Todo updated successfully!</p>
    <% } else if (msg === 'deleted') { %>
      <p class="success">Todo deleted successfully!</p>
    <% } %>

    <h2>Create New Todo</h2>
    <form action="/todos/preview" method="GET">
      <input type="text" name="title" placeholder="Title" required>
      <input type="text" name="description" placeholder="Description">
      <div class="datetime-picker">
        <label>Due Date (optional):</label>
        <input type="date" name="dueDate">
        <label>Due Time (optional):</label>
        <input type="time" name="dueTime">
      </div>
      <button type="submit">Preview & Confirm</button>
    </form>

    <h2>Search Todos</h2>
    <form action="/todos" method="GET">
      <input type="text" name="search" value="<%= search %>" placeholder="Search by title...">
      <input type="date" name="searchDate" value="<%= searchDate %>" placeholder="Search by date...">
      <button>Search</button>
    </form>

    <% if (search) { %>
      <p><strong><%= todos.length %></strong> item(s) found for "<%= search %>"</p>
    <% } else { %>
      <p><strong><%= todos.length %></strong> total todo(s)</p>
    <% } %>

    <h2>Todo List</h2>
    <% if (todos.length === 0) { %>
      <p>No todos found.</p>
    <% } else { %>
      <ul>
        <% todos.forEach(todo => { %>
          <li>
            <strong><%= todo.title %></strong><br>
            <%= todo.description || '(No description)' %>
            <br>
            <small class="owner">
              <% if (todo.updatedAt) { %>
                Edited by: <strong><%= todo.updatedBy %></strong> on 
                <%= new Date(todo.updatedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %> at 
                <%= new Date(todo.updatedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Hong_Kong' }) %> HKT
              <% } else { %>
                Added by: <strong><%= todo.username %></strong> on 
                <%= new Date(todo.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %> at 
                <%= new Date(todo.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Hong_Kong' }) %> HKT
              <% } %>
              <% if (todo.dueDate) { %>
                <% 
                  const due = new Date(todo.dueDate);
                  const now = new Date();
                  const diffMs = due - now;
                  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                  const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                  let countdown = '';
                  if (diffMs < 0) {
                    countdown = 'Overdue';
                  } else if (diffDays > 0) {
                    countdown = `${diffDays} day${diffDays > 1 ? 's' : ''} left`;
                  } else if (diffHours > 0) {
                    countdown = `${diffHours} hour${diffHours > 1 ? 's' : ''} left`;
                  } else if (diffMins > 0) {
                    countdown = `${diffMins} min${diffMins > 1 ? 's' : ''} left`;
                  } else {
                    countdown = 'Due now';
                  }
                %>
                <br><small class="due-date">
                  Due: <%= due.toLocaleString('en-GB', { 
                    timeZone: 'Asia/Hong_Kong', 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', hour12: true 
                  }) %> HKT
                  <span class="countdown">(<%= countdown %>)</span>
                </small>
              <% } %>
            </small>
            <div class="actions">
              <a href="/todos/edit/<%= todo._id %>">Edit</a>
              <button class="delete-btn" onclick="confirmDelete('<%= todo._id %>', '<%= todo.title %>')">
                Delete
              </button>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
  <script>
  function confirmDelete(id, title) {
    if (confirm(`Are you sure you want to delete "${title}"?`)) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/todos/delete/${id}`;
      document.body.appendChild(form);
      form.submit();
    }
  }
  </script>
</body>
</html>
